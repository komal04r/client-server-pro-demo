<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>📚 Book Reading Progress Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--
      Book Reading Progress Tracker
      Single-file app with inline CSS and JS.
      Features:
      - Add, edit, delete books (title, author, total pages, optional cover)
      - Update reading progress via number input and slider
      - Progress bars with color-coded status
      - Filter by Not Started, In Progress, Completed
      - Sort by title, author, progress, added time
      - Search by title or author
      - Tags and tag-based filtering
      - Notes per book
      - Reading sessions (date, pages, minutes) with simple timeline
      - Stats summary (totals, completion, per-status counts)
      - Favorite and rating
      - Import/Export JSON
      - Dark mode with persistence
      - LocalStorage for all data
      - Cozy, library-inspired design
      - Responsive layout and accessible controls
    -->
    <style>
        /* =========================
           Theme and base variables
           ========================= */
        :root {
            --bg: #f4f1ea;
            --surface: #fff8f0;
            --text: #3e3e3e;
            --muted: #7a715f;
            --primary: #8b5e3c;
            --primary-700: #714a2f;
            --accent: #c28f6b;
            --border: #e3d7c8;
            --progress-bg: #e0d4c3;
            --progress-inprogress: #b77a50;
            --progress-complete: #4caf50;
            --progress-not: #9e9e9e;
            --favorite: #d9a441;
            --danger: #b4463a;
            --success: #3f7c57;
            --focus: #2e6ddf;
            --chip-bg: #efe7dc;
            --chip-text: #5a4a3a;
            --shadow: 0 8px 20px rgba(100, 70, 30, 0.15);
            --radius: 12px;
        }
        body.dark {
            --bg: #1d1a16;
            --surface: #262018;
            --text: #e7dccb;
            --muted: #b8a893;
            --primary: #cfa47f;
            --primary-700: #b2855d;
            --accent: #d9b28f;
            --border: #3b3228;
            --progress-bg: #3b3228;
            --progress-inprogress: #cfa47f;
            --progress-complete: #58c56e;
            --progress-not: #8e8e8e;
            --favorite: #e1ba57;
            --danger: #d0675d;
            --success: #59a37a;
            --shadow: 0 10px 24px rgba(0,0,0,0.35);
        }

        /* ============ Base ============ */
        html, body {
            height: 100%;
        }
        body {
            margin: 0;
            font-family: Georgia, "Times New Roman", Times, serif;
            background: var(--bg);
            color: var(--text);
            transition: background 0.3s ease, color 0.3s ease;
        }
        a { color: inherit; }
        button, input, select, textarea {
            font-family: inherit;
        }

        /* ============ Layout ============ */
        header.app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: linear-gradient(180deg, rgba(139,94,60,0.08), transparent);
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(6px);
            border-bottom: 1px solid var(--border);
        }
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .brand .logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: radial-gradient(circle at 30% 30%, var(--primary), var(--accent));
            box-shadow: var(--shadow);
            display: grid;
            place-items: center;
            color: white;
            font-weight: bold;
        }
        .brand h1 {
            font-size: 1.4rem;
            margin: 0;
            color: var(--primary-700);
        }
        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ============ Controls ============ */
        .toolbar {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            margin-bottom: 16px;
        }
        .search-group {
            display: grid;
            grid-template-columns: 1.4fr 1fr 1fr 1fr;
            gap: 8px;
        }
        .search-group .field,
        .toolbar .group {
            background: var(--surface);
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .field input[type="text"],
        .field select {
            width: 100%;
            border: none;
            outline: none;
            background: transparent;
            color: var(--text);
            font-size: 0.95rem;
        }
        .btn {
            border: 1px solid var(--border);
            background: var(--primary);
            color: white;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.06s ease, background 0.2s ease, box-shadow 0.2s ease;
            box-shadow: var(--shadow);
        }
        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn.secondary {
            background: var(--surface);
            color: var(--text);
        }
        .btn.outline {
            background: transparent;
            color: var(--primary-700);
            border: 1px solid var(--primary-700);
        }
        .btn.danger {
            background: var(--danger);
            color: #fff;
        }
        .btn.success {
            background: var(--success);
            color: #fff;
        }
        .switch {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 999px;
            background: var(--surface);
            box-shadow: var(--shadow);
            cursor: pointer;
            user-select: none;
        }

        /* ============ Chips ============ */
        .chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 12px 0 18px 0;
        }
        .chip {
            background: var(--chip-bg);
            color: var(--chip-text);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.08s ease;
        }
        .chip.active {
            background: var(--primary);
            color: #fff5e6;
            border-color: transparent;
        }
        .chip:hover { transform: translateY(-1px); }

        /* ============ Stats ============ */
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 8px 0 20px;
        }
        .stat {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 12px;
        }
        .stat .label { color: var(--muted); font-size: 0.85rem; }
        .stat .value { font-size: 1.4rem; margin-top: 4px; }

        /* ============ Book list ============ */
        .book-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        .book {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: grid;
            grid-template-columns: 80px 1fr auto;
            gap: 14px;
            padding: 12px;
            align-items: flex-start;
        }
        .cover {
            width: 80px;
            height: 110px;
            border-radius: 8px;
            overflow: hidden;
            background: linear-gradient(135deg, var(--progress-bg), var(--chip-bg));
            border: 1px solid var(--border);
        }
        .cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .placeholder {
            width: 100%;
            height: 100%;
            display: grid;
            place-items: center;
            color: var(--muted);
            font-size: 0.8rem;
        }
        .details {
            display: grid;
            gap: 6px;
        }
        .title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .title {
            font-weight: bold;
            color: var(--primary-700);
        }
        .meta {
            color: var(--muted);
            font-size: 0.9rem;
        }
        .tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .tag {
            background: var(--chip-bg);
            color: var(--chip-text);
            border: 1px solid var(--border);
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.8rem;
        }
        .progress-wrap {
            display: grid;
            gap: 6px;
        }
        .progress-bar {
            height: 10px;
            background: var(--progress-bg);
            border-radius: 999px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        .progress-bar .bar {
            height: 100%;
            width: 0%;
            background: var(--progress-inprogress);
            transition: width 0.25s ease;
        }
        .progress-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--muted);
            font-size: 0.9rem;
        }
        .controls {
            display: grid;
            gap: 6px;
            min-width: 230px;
        }
        .controls .row {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        input[type="number"] {
            width: 90px;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text);
            outline: none;
        }
        input[type="range"] {
            width: 160px;
            accent-color: var(--primary);
        }
        .status-badge {
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 0.8rem;
            border: 1px solid var(--border);
        }
        .status-not { background: #f0f0f0; color: #555; }
        body.dark .status-not { background: #343434; color: #cfcfcf; }
        .status-in { background: #fff1e3; color: #7a4d2e; }
        body.dark .status-in { background: #3b2c23; color: #e7c6a2; }
        .status-done { background: #e5f5e9; color: #2e6b3b; }
        body.dark .status-done { background: #244332; color: #9dd6a8; }

        .favorite {
            color: var(--favorite);
            cursor: pointer;
            font-size: 1.2rem;
            user-select: none;
            transition: transform 0.08s ease;
        }
        .favorite:hover { transform: scale(1.05); }
        .rating {
            display: inline-flex;
            gap: 2px;
            cursor: pointer;
        }
        .rating .star {
            font-size: 1rem;
            color: #c8c8c8;
        }
        .rating .star.active { color: var(--favorite); }

        .session-list {
            margin-top: 6px;
            border-left: 3px solid var(--border);
            padding-left: 10px;
            color: var(--muted);
            font-size: 0.9rem;
            max-height: 120px;
            overflow: auto;
        }
        .session-item {
            display: flex;
            gap: 8px;
            align-items: baseline;
            padding: 2px 0;
        }

        /* ============ Modals ============ */
        .modal {
            position: fixed;
            inset: 0;
            display: none;
            place-items: center;
            background: rgba(0,0,0,0.45);
            z-index: 50;
            padding: 20px;
        }
        .modal.open { display: grid; }
        .modal-card {
            width: 100%;
            max-width: 560px;
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 16px;
        }
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .modal-body {
            display: grid;
            gap: 10px;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        label {
            display: grid;
            gap: 6px;
            font-size: 0.9rem;
            color: var(--muted);
        }
        .input {
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            padding: 10px;
            border-radius: 10px;
            outline: none;
        }
        textarea.input {
            min-height: 80px;
            resize: vertical;
        }

        /* ============ Footer ============ */
        footer {
            text-align: center;
            color: var(--muted);
            padding: 20px 0 30px;
        }

        /* ============ Empty state ============ */
        .empty {
            border: 2px dashed var(--border);
            color: var(--muted);
            background: var(--surface);
            padding: 28px;
            border-radius: var(--radius);
            text-align: center;
        }

        /* ============ Responsive ============ */
        @media (max-width: 900px) {
            .toolbar {
                grid-template-columns: 1fr;
            }
            .search-group {
                grid-template-columns: 1fr 1fr;
            }
        }
        @media (max-width: 640px) {
            .search-group {
                grid-template-columns: 1fr;
            }
            .stats {
                grid-template-columns: 1fr 1fr;
            }
            .book {
                grid-template-columns: 70px 1fr;
            }
            .controls {
                grid-column: span 2;
                min-width: 0;
            }
        }
    </style>
</head>
<body>
<header class="app-header" role="banner">
    <div class="brand" aria-label="App title">
        <div class="logo" aria-hidden="true">📖</div>
        <h1>My Reading Tracker</h1>
    </div>
    <div class="actions">
        <label class="switch" title="Toggle dark mode">
            <input id="darkToggle" type="checkbox" aria-label="Dark mode" />
            <span>🌙 Dark</span>
        </label>
        <button id="exportBtn" class="btn secondary" title="Export your library">⬇️ Export</button>
        <label for="importInput" class="btn secondary" title="Import a library JSON">⬆️ Import</label>
        <input id="importInput" type="file" accept="application/json" style="display:none" />
    </div>
</header>

<main class="container" role="main">
    <section class="toolbar" aria-label="Search and filters">
        <div class="search-group">
            <div class="field" title="Search">
                🔎
                <input id="searchInput" type="text" placeholder="Search title or author..." />
            </div>
            <div class="field" title="Filter by status">
                🗂️
                <select id="statusFilter">
                    <option value="all">All statuses</option>
                    <option value="notStarted">Not Started</option>
                    <option value="inProgress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <div class="field" title="Sort books">
                🧭
                <select id="sortSelect">
                    <option value="addedDesc">Recently Added</option>
                    <option value="titleAsc">Title A→Z</option>
                    <option value="authorAsc">Author A→Z</option>
                    <option value="progressDesc">Progress High→Low</option>
                    <option value="pagesDesc">Pages High→Low</option>
                </select>
            </div>
            <div class="field" title="Quick actions">
                ✨
                <button id="addBookBtn" class="btn success">➕ Add book</button>
            </div>
        </div>
        <div class="group" title="Helpful tips">
            💡 Pro tip: Use tags like “work”, “fun”, or “classic” to group books. Click chips below to filter.
        </div>
    </section>

    <section id="tagChips" class="chips" aria-label="Tag filters">
        <!-- dynamic tag chips -->
    </section>

    <section id="stats" class="stats" aria-label="Library stats">
        <!-- dynamic stats cards -->
    </section>

    <section id="bookList" class="book-list" aria-live="polite">
        <!-- dynamic book cards -->
    </section>

    <section id="emptyState" class="empty" style="display:none" aria-live="polite">
        Your shelf looks a little bare. Add your first book to begin tracking your reading adventure.
    </section>
</main>

<footer role="contentinfo">
    Built with care. Your data stays in your browser via localStorage.
</footer>

<!-- ========== Book Modal ========== -->
<div id="bookModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="bookModalTitle">
    <div class="modal-card">
        <div class="modal-header">
            <h2 id="bookModalTitle">Add book</h2>
            <button class="btn outline" id="closeBookModal" aria-label="Close">✖</button>
        </div>
        <div class="modal-body">
            <div class="grid-2">
                <label>
                    Title
                    <input id="bmTitle" class="input" type="text" placeholder="e.g., The Pragmatic Programmer" />
                </label>
                <label>
                    Author
                    <input id="bmAuthor" class="input" type="text" placeholder="e.g., Andrew Hunt" />
                </label>
            </div>
            <div class="grid-2">
                <label>
                    Total pages
                    <input id="bmPages" class="input" type="number" min="1" placeholder="e.g., 352" />
                </label>
                <label>
                    Cover image URL (optional)
                    <input id="bmCover" class="input" type="url" placeholder="https://..." />
                </label>
            </div>
            <div class="grid-2">
                <label>
                    Tags (comma-separated)
                    <input id="bmTags" class="input" type="text" placeholder="e.g., tech, classics, sci-fi" />
                </label>
                <label>
                    Start pages read (optional)
                    <input id="bmRead" class="input" type="number" min="0" placeholder="0" />
                </label>
            </div>
            <label>
                Notes (optional)
                <textarea id="bmNotes" class="input" placeholder="What’s your intention for this book?"></textarea>
            </label>
            <div class="modal-actions">
                <button id="bmDelete" class="btn danger" style="margin-right:auto; display:none">🗑️ Delete</button>
                <button id="bmSave" class="btn success">💾 Save</button>
                <button id="bmCancel" class="btn secondary">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- ========== Session Modal ========== -->
<div id="sessionModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="sessionModalTitle">
    <div class="modal-card">
        <div class="modal-header">
            <h2 id="sessionModalTitle">Add reading session</h2>
            <button class="btn outline" id="closeSessionModal" aria-label="Close">✖</button>
        </div>
        <div class="modal-body">
            <div class="grid-2">
                <label>
                    Date
                    <input id="smDate" class="input" type="date" />
                </label>
                <label>
                    Minutes
                    <input id="smMinutes" class="input" type="number" min="1" placeholder="e.g., 30" />
                </label>
            </div>
            <label>
                Pages read this session
                <input id="smPages" class="input" type="number" min="0" placeholder="e.g., 20" />
            </label>
            <div class="modal-actions">
                <button id="smSave" class="btn success">➕ Add session</button>
                <button id="smCancel" class="btn secondary">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    // =========================
    // Helpers and persistence
    // =========================

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    const STORAGE_KEYS = {
        BOOKS: 'book-tracker.books.v1',
        SETTINGS: 'book-tracker.settings.v1'
    };

    const state = {
        books: [],
        filter: {
            status: 'all',
            search: '',
            sort: 'addedDesc',
            tag: 'all'
        },
        ui: {
            dark: false,
            editingId: null,
            sessionForId: null
        }
    };

    function uid() {
        return 'b_' + Math.random().toString(36).slice(2, 9) + Date.now().toString(36);
    }

    function nowISO() {
        return new Date().toISOString();
    }

    function clamp(n, min, max) {
        return Math.max(min, Math.min(max, n));
    }

    function fmtPercent(p) {
        return `${Math.round(p)}%`;
    }

    function readSettings() {
        try {
            const raw = localStorage.getItem(STORAGE_KEYS.SETTINGS);
            return raw ? JSON.parse(raw) : {};
        } catch {
            return {};
        }
    }

    function saveSettings() {
        localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify({
            dark: state.ui.dark
        }));
    }

    function readBooks() {
        try {
            const raw = localStorage.getItem(STORAGE_KEYS.BOOKS);
            const items = raw ? JSON.parse(raw) : [];
            return Array.isArray(items) ? items : [];
        } catch {
            return [];
        }
    }

    function saveBooks() {
        localStorage.setItem(STORAGE_KEYS.BOOKS, JSON.stringify(state.books));
    }

    // =========================
    // Initialization
    // =========================

    function init() {
        // Load settings
        const settings = readSettings();
        state.ui.dark = !!settings.dark;
        document.body.classList.toggle('dark', state.ui.dark);
        $('#darkToggle').checked = state.ui.dark;

        // Load books
        state.books = readBooks();

        // Wire events
        wireControls();

        // Initial render
        renderAll();
    }

    document.addEventListener('DOMContentLoaded', init);

    // =========================
    // Event wiring
    // =========================

    function wireControls() {
        // Dark mode toggle
        $('#darkToggle').addEventListener('change', (e) => {
            state.ui.dark = !!e.target.checked;
            document.body.classList.toggle('dark', state.ui.dark);
            saveSettings();
        });

        // Add book button
        $('#addBookBtn').addEventListener('click', () => openBookModal());

        // Search input with small debounce
        let searchTimer;
        $('#searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                state.filter.search = e.target.value.trim().toLowerCase();
                renderList();
                renderStats();
            }, 120);
        });

        // Status filter
        $('#statusFilter').addEventListener('change', (e) => {
            state.filter.status = e.target.value;
            renderList();
            renderStats();
        });

        // Sort select
        $('#sortSelect').addEventListener('change', (e) => {
            state.filter.sort = e.target.value;
            renderList();
        });

        // Import/Export
        $('#exportBtn').addEventListener('click', exportLibrary);
        $('#importInput').addEventListener('change', importLibrary);

        // Book modal events
        $('#closeBookModal').addEventListener('click', closeBookModal);
        $('#bmCancel').addEventListener('click', closeBookModal);
        $('#bmSave').addEventListener('click', onSaveBook);
        $('#bmDelete').addEventListener('click', onDeleteBook);

        // Session modal events
        $('#closeSessionModal').addEventListener('click', closeSessionModal);
        $('#smCancel').addEventListener('click', closeSessionModal);
        $('#smSave').addEventListener('click', onSaveSession);

        // Close modals on backdrop click
        $('#bookModal').addEventListener('click', (e) => {
            if (e.target.id === 'bookModal') closeBookModal();
        });
        $('#sessionModal').addEventListener('click', (e) => {
            if (e.target.id === 'sessionModal') closeSessionModal();
        });

        // Escape to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeBookModal();
                closeSessionModal();
            }
        });
    }

    // =========================
    // Rendering
    // =========================

    function renderAll() {
        renderTagChips();
        renderStats();
        renderList();
        updateEmptyState();
    }

    function updateEmptyState() {
        const hasAny = state.books.length > 0;
        $('#emptyState').style.display = hasAny ? 'none' : 'block';
    }

    function renderTagChips() {
        const host = $('#tagChips');
        host.innerHTML = '';
        const tagCounts = new Map();
        state.books.forEach(b => {
            (b.tags || []).forEach(t => {
                const key = t.trim().toLowerCase();
                if (!key) return;
                tagCounts.set(key, (tagCounts.get(key) || 0) + 1);
            });
        });

        const allChip = document.createElement('div');
        allChip.className = 'chip' + (state.filter.tag === 'all' ? ' active' : '');
        allChip.textContent = `All tags`;
        allChip.addEventListener('click', () => {
            state.filter.tag = 'all';
            renderList();
            renderStats();
            renderTagChips();
        });
        host.appendChild(allChip);

        [...tagCounts.entries()]
            .sort((a,b) => b[1]-a[1] || a[0].localeCompare(b[0]))
            .forEach(([tag, count]) => {
                const chip = document.createElement('div');
                chip.className = 'chip' + (state.filter.tag === tag ? ' active' : '');
                chip.textContent = `${tag} (${count})`;
                chip.title = `Filter tag: ${tag}`;
                chip.addEventListener('click', () => {
                    state.filter.tag = state.filter.tag === tag ? 'all' : tag;
                    renderList();
                    renderStats();
                    renderTagChips();
                });
                host.appendChild(chip);
            });
    }

    function summarize() {
        const all = state.books;
        const totalBooks = all.length;
        const totalPages = all.reduce((s, b) => s + (b.pages || 0), 0);
        const totalRead = all.reduce((s, b) => s + Math.min(b.read || 0, b.pages || 0), 0);

        const ns = all.filter(b => (b.read || 0) <= 0).length;
        const ip = all.filter(b => (b.read || 0) > 0 && (b.read || 0) < (b.pages || 0)).length;
        const done = all.filter(b => (b.read || 0) >= (b.pages || 0) && (b.pages || 0) > 0).length;

        const completion = totalPages > 0 ? (totalRead / totalPages) * 100 : 0;

        return { totalBooks, totalPages, totalRead, completion, ns, ip, done };
    }

    function renderStats() {
        const s = summarize();
        const host = $('#stats');
        host.innerHTML = '';

        const mk = (label, value) => {
            const el = document.createElement('div');
            el.className = 'stat';
            el.innerHTML = `
          <div class="label">${label}</div>
          <div class="value">${value}</div>
        `;
            return el;
        };

        host.appendChild(mk('Books', s.totalBooks));
        host.appendChild(mk('Pages read', s.totalRead));
        host.appendChild(mk('Total pages', s.totalPages));
        host.appendChild(mk('Completion', fmtPercent(s.completion)));

        // Add badge row below stats
        const row = document.createElement('div');
        row.style.gridColumn = '1 / -1';
        row.style.marginTop = '6px';
        row.innerHTML = `
        <span class="status-badge status-not">Not Started: ${s.ns}</span>
        <span class="status-badge status-in" style="margin-left:8px">In Progress: ${s.ip}</span>
        <span class="status-badge status-done" style="margin-left:8px">Completed: ${s.done}</span>
      `;
        host.appendChild(row);
    }

    function getStatus(book) {
        const read = book.read || 0;
        const pages = book.pages || 0;
        if (pages <= 0 || read <= 0) return 'notStarted';
        if (read >= pages) return 'completed';
        return 'inProgress';
    }

    function filterSortBooks() {
        // Filter
        let list = state.books.filter(b => {
            // search
            if (state.filter.search) {
                const q = state.filter.search;
                const hit = (b.title || '').toLowerCase().includes(q) || (b.author || '').toLowerCase().includes(q);
                if (!hit) return false;
            }
            // status
            const st = getStatus(b);
            if (state.filter.status !== 'all' && st !== state.filter.status) return false;
            // tag
            if (state.filter.tag !== 'all') {
                const tags = (b.tags || []).map(t => (t||'').toLowerCase());
                if (!tags.includes(state.filter.tag)) return false;
            }
            return true;
        });

        // Sort
        const by = state.filter.sort;
        list.sort((a, b) => {
            if (by === 'titleAsc') return (a.title || '').localeCompare(b.title || '');
            if (by === 'authorAsc') return (a.author || '').localeCompare(b.author || '');
            if (by === 'progressDesc') {
                const pa = (a.pages || 0) ? (a.read || 0) / a.pages : 0;
                const pb = (b.pages || 0) ? (b.read || 0) / b.pages : 0;
                return pb - pa;
            }
            if (by === 'pagesDesc') return (b.pages || 0) - (a.pages || 0);
            // default: addedDesc
            return new Date(b.addedAt || 0) - new Date(a.addedAt || 0);
        });

        return list;
    }

    function renderList() {
        const host = $('#bookList');
        host.innerHTML = '';
        const list = filterSortBooks();

        list.forEach(book => {
            const card = renderBookCard(book);
            host.appendChild(card);
        });

        updateEmptyState();
    }

    function renderBookCard(book) {
        const percent = (book.pages || 0) ? clamp((book.read || 0) / book.pages * 100, 0, 100) : 0;
        const status = getStatus(book);

        const el = document.createElement('article');
        el.className = 'book';
        el.setAttribute('data-id', book.id);

        // Cover
        const cover = document.createElement('div');
        cover.className = 'cover';
        if (book.cover) {
            const img = document.createElement('img');
            img.src = book.cover;
            img.alt = `${book.title} cover`;
            img.onerror = () => {
                img.remove();
                cover.appendChild(placeholder());
            };
            cover.appendChild(img);
        } else {
            cover.appendChild(placeholder());
        }
        el.appendChild(cover);

        // Details
        const details = document.createElement('div');
        details.className = 'details';

        const titleRow = document.createElement('div');
        titleRow.className = 'title-row';

        const left = document.createElement('div');
        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = book.title || 'Untitled';

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `${book.author || 'Unknown'} • ${book.pages || 0} pages`;
        left.appendChild(title);
        left.appendChild(meta);

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.alignItems = 'center';
        right.style.gap = '8px';

        const badge = document.createElement('span');
        badge.className = 'status-badge ' + (status === 'completed' ? 'status-done' : status === 'inProgress' ? 'status-in' : 'status-not');
        badge.textContent = status === 'completed' ? 'Completed' : status === 'inProgress' ? 'In Progress' : 'Not Started';

        const fav = document.createElement('span');
        fav.className = 'favorite';
        fav.textContent = book.favorite ? '★' : '☆';
        fav.title = 'Toggle favorite';
        fav.addEventListener('click', () => {
            book.favorite = !book.favorite;
            saveBooks();
            renderList();
        });

        const rating = document.createElement('div');
        rating.className = 'rating';
        for (let i = 1; i <= 5; i++) {
            const star = document.createElement('span');
            star.className = 'star' + ((book.rating || 0) >= i ? ' active' : '');
            star.textContent = '★';
            star.title = `Rate ${i} star${i>1?'s':''}`;
            star.addEventListener('click', () => {
                book.rating = i;
                saveBooks();
                renderList();
            });
            rating.appendChild(star);
        }

        right.appendChild(badge);
        right.appendChild(rating);
        right.appendChild(fav);

        titleRow.appendChild(left);
        titleRow.appendChild(right);

        const tags = document.createElement('div');
        tags.className = 'tags';
        (book.tags || []).forEach(t => {
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.textContent = t;
            tags.appendChild(tag);
        });

        const notes = document.createElement('div');
        notes.className = 'meta';
        if ((book.notes || '').trim()) {
            notes.textContent = `“${book.notes.trim()}”`;
        }

        const prog = document.createElement('div');
        prog.className = 'progress-wrap';

        const bar = document.createElement('div');
        bar.className = 'progress-bar';
        const fill = document.createElement('div');
        fill.className = 'bar';
        fill.style.width = `${percent}%`;
        fill.style.background = status === 'completed' ? 'var(--progress-complete)' :
            status === 'notStarted' ? 'var(--progress-not)' :
                'var(--progress-inprogress)';
        bar.appendChild(fill);

        const info = document.createElement('div');
        info.className = 'progress-info';
        const leftInfo = document.createElement('div');
        leftInfo.textContent = `${Math.min(book.read || 0, book.pages || 0)} / ${book.pages || 0} pages (${fmtPercent(percent)})`;
        const rightInfo = document.createElement('div');
        rightInfo.textContent = book.updatedAt ? `Updated ${relativeTime(book.updatedAt)}` : `Added ${relativeTime(book.addedAt)}`;
        info.appendChild(leftInfo);
        info.appendChild(rightInfo);

        const sess = renderSessionList(book);

        prog.appendChild(bar);
        prog.appendChild(info);
        prog.appendChild(sess);

        details.appendChild(titleRow);
        if ((book.tags || []).length) details.appendChild(tags);
        if ((book.notes || '').trim()) details.appendChild(notes);
        details.appendChild(prog);

        el.appendChild(details);

        // Controls
        const controls = document.createElement('div');
        controls.className = 'controls';

        // Row 1: progress input + slider
        const row1 = document.createElement('div');
        row1.className = 'row';
        const inp = document.createElement('input');
        inp.type = 'number';
        inp.min = 0;
        inp.max = book.pages || 0;
        inp.value = clamp(book.read || 0, 0, book.pages || 0);
        inp.title = 'Pages read';
        inp.addEventListener('change', () => {
            const val = clamp(parseInt(inp.value || '0', 10), 0, book.pages || 0);
            book.read = val;
            book.updatedAt = nowISO();
            saveBooks();
            renderList();
            renderStats();
        });

        const slider = document.createElement('input');
        slider.type = 'range';
        slider.min = 0;
        slider.max = book.pages || 0;
        slider.value = clamp(book.read || 0, 0, book.pages || 0);
        slider.title = 'Adjust progress';
        slider.addEventListener('input', () => {
            inp.value = slider.value;
            const val = parseInt(slider.value || '0', 10);
            book.read = val;
            book.updatedAt = nowISO();
            saveBooks();
            // live bar update
            fill.style.width = `${(book.pages ? (book.read / book.pages * 100) : 0)}%`;
            leftInfo.textContent = `${Math.min(book.read || 0, book.pages || 0)} / ${book.pages || 0} pages (${fmtPercent(book.pages? (book.read / book.pages * 100) : 0)})`;
        });
        slider.addEventListener('change', () => {
            renderList();
            renderStats();
        });

        row1.appendChild(inp);
        row1.appendChild(slider);

        // Row 2: quick buttons
        const row2 = document.createElement('div');
        row2.className = 'row';
        const add10 = mkBtn('➕ +10', 'secondary', () => adjustRead(book, 10));
        const sub5 = mkBtn('➖ -5', 'secondary', () => adjustRead(book, -5));
        const done = mkBtn('✅ Mark done', 'success', () => {
            book.read = book.pages || 0;
            book.updatedAt = nowISO();
            saveBooks();
            renderList();
            renderStats();
        });
        const reset = mkBtn('↺ Reset', 'secondary', () => {
            book.read = 0;
            book.updatedAt = nowISO();
            saveBooks();
            renderList();
            renderStats();
        });
        row2.appendChild(add10);
        row2.appendChild(sub5);
        row2.appendChild(done);
        row2.appendChild(reset);

        // Row 3: manage buttons
        const row3 = document.createElement('div');
        row3.className = 'row';
        const edit = mkBtn('✏️ Edit', 'outline', () => openBookModal(book.id));
        const session = mkBtn('🕒 Session', 'outline', () => openSessionModal(book.id));
        const del = mkBtn('🗑️ Delete', 'danger', () => confirmDelete(book.id));
        row3.appendChild(edit);
        row3.appendChild(session);
        row3.appendChild(del);

        controls.appendChild(row1);
        controls.appendChild(row2);
        controls.appendChild(row3);

        el.appendChild(controls);

        return el;
    }

    function placeholder() {
        const ph = document.createElement('div');
        ph.className = 'placeholder';
        ph.innerHTML = 'No cover';
        return ph;
    }

    function mkBtn(text, variant, onClick) {
        const b = document.createElement('button');
        b.className = 'btn ' + (variant || '');
        b.textContent = text;
        b.addEventListener('click', onClick);
        return b;
    }

    function renderSessionList(book) {
        const wrap = document.createElement('div');
        const toggle = document.createElement('button');
        toggle.className = 'btn secondary';
        toggle.textContent = '📘 Sessions (' + ((book.sessions || []).length) + ')';
        toggle.style.width = 'fit-content';
        const list = document.createElement('div');
        list.className = 'session-list';
        list.style.display = 'none';

        toggle.addEventListener('click', () => {
            list.style.display = list.style.display === 'none' ? 'block' : 'none';
        });

        (book.sessions || [])
            .slice()
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .forEach(s => {
                const item = document.createElement('div');
                item.className = 'session-item';
                const when = document.createElement('span');
                when.textContent = formatDateYMD(s.date);
                const what = document.createElement('span');
                const pages = typeof s.pages === 'number' ? `${s.pages} pages` : '';
                const mins = typeof s.minutes === 'number' ? `${s.minutes} min` : '';
                what.textContent = [pages, mins].filter(Boolean).join(' • ');
                item.appendChild(when);
                item.appendChild(document.createTextNode('—'));
                item.appendChild(what);
                list.appendChild(item);
            });

        wrap.appendChild(toggle);
        wrap.appendChild(list);
        return wrap;
    }

    function relativeTime(iso) {
        if (!iso) return 'just now';
        const diff = Date.now() - new Date(iso).getTime();
        const sec = Math.round(diff / 1000);
        if (sec < 60) return `${sec}s ago`;
        const min = Math.round(sec / 60);
        if (min < 60) return `${min}m ago`;
        const hr = Math.round(min / 60);
        if (hr < 24) return `${hr}h ago`;
        const day = Math.round(hr / 24);
        if (day < 30) return `${day}d ago`;
        const mon = Math.round(day / 30);
        if (mon < 12) return `${mon}mo ago`;
        const yr = Math.round(mon / 12);
        return `${yr}y ago`;
    }

    function formatDateYMD(d) {
        const dt = new Date(d);
        if (Number.isNaN(dt.getTime())) return 'Unknown date';
        const y = dt.getFullYear();
        const m = String(dt.getMonth() + 1).padStart(2, '0');
        const da = String(dt.getDate()).padStart(2, '0');
        return `${y}-${m}-${da}`;
    }

    // =========================
    // Book CRUD
    // =========================

    function openBookModal(id = null) {
        state.ui.editingId = id;
        const editing = id ? state.books.find(b => b.id === id) : null;

        $('#bookModalTitle').textContent = editing ? 'Edit book' : 'Add book';
        $('#bmDelete').style.display = editing ? 'inline-block' : 'none';

        $('#bmTitle').value = editing?.title || '';
        $('#bmAuthor').value = editing?.author || '';
        $('#bmPages').value = editing?.pages || '';
        $('#bmCover').value = editing?.cover || '';
        $('#bmTags').value = (editing?.tags || []).join(', ');
        $('#bmRead').value = editing?.read ?? '';
        $('#bmNotes').value = editing?.notes || '';

        $('#bookModal').classList.add('open');
        $('#bmTitle').focus();
    }

    function closeBookModal() {
        $('#bookModal').classList.remove('open');
        state.ui.editingId = null;
    }

    function onSaveBook() {
        const title = $('#bmTitle').value.trim();
        const author = $('#bmAuthor').value.trim();
        const pages = parseInt($('#bmPages').value, 10);
        const cover = $('#bmCover').value.trim();
        const tagsRaw = $('#bmTags').value.trim();
        const readStart = parseInt($('#bmRead').value || '0', 10);
        const notes = $('#bmNotes').value.trim();

        if (!title || !author || !Number.isFinite(pages) || pages <= 0) {
            alert('Please provide a title, author, and total pages (> 0).');
            return;
        }

        const tags = tagsRaw ? tagsRaw.split(',').map(s => s.trim()).filter(Boolean) : [];
        const read = clamp(Number.isFinite(readStart) ? readStart : 0, 0, pages);

        if (state.ui.editingId) {
            // update
            const idx = state.books.findIndex(b => b.id === state.ui.editingId);
            if (idx >= 0) {
                const prev = state.books[idx];
                state.books[idx] = {
                    ...prev,
                    title, author, pages, cover,
                    tags, notes,
                    read: clamp(read, 0, pages),
                    updatedAt: nowISO()
                };
            }
        } else {
            // create
            state.books.push({
                id: uid(),
                title, author, pages, cover,
                tags, notes,
                favorite: false,
                rating: 0,
                read,
                sessions: [],
                addedAt: nowISO(),
                updatedAt: nowISO()
            });
        }

        saveBooks();
        closeBookModal();
        renderTagChips();
        renderStats();
        renderList();
        updateEmptyState();
    }

    function confirmDelete(id) {
        const book = state.books.find(b => b.id === id);
        if (!book) return;
        const ok = confirm(`Delete “${book.title}” by ${book.author}? This cannot be undone.`);
        if (ok) {
            state.books = state.books.filter(b => b.id !== id);
            saveBooks();
            renderTagChips();
            renderStats();
            renderList();
            updateEmptyState();
        }
    }

    function onDeleteBook() {
        if (!state.ui.editingId) return;
        confirmDelete(state.ui.editingId);
        closeBookModal();
    }

    function adjustRead(book, delta) {
        const pages = book.pages || 0;
        const next = clamp((book.read || 0) + delta, 0, pages);
        book.read = next;
        book.updatedAt = nowISO();
        saveBooks();
        renderList();
        renderStats();
    }

    // =========================
    // Sessions
    // =========================

    function openSessionModal(bookId) {
        state.ui.sessionForId = bookId;
        const today = new Date();
        $('#smDate').value = formatDateYMD(today);
        $('#smMinutes').value = '';
        $('#smPages').value = '';
        $('#sessionModalTitle').textContent = 'Add reading session';
        $('#sessionModal').classList.add('open');
        $('#smDate').focus();
    }

    function closeSessionModal() {
        $('#sessionModal').classList.remove('open');
        state.ui.sessionForId = null;
    }

    function onSaveSession() {
        const id = state.ui.sessionForId;
        const book = state.books.find(b => b.id === id);
        if (!book) return;

        const date = $('#smDate').value || formatDateYMD(new Date());
        const minutes = parseInt($('#smMinutes').value || '0', 10);
        const pages = parseInt($('#smPages').value || '0', 10);

        if (!Number.isFinite(minutes) && !Number.isFinite(pages)) {
            alert('Add minutes or pages for the session.');
            return;
        }

        book.sessions = book.sessions || [];
        book.sessions.push({
            date,
            minutes: Number.isFinite(minutes) && minutes > 0 ? minutes : undefined,
            pages: Number.isFinite(pages) && pages > 0 ? pages : undefined
        });

        if (Number.isFinite(pages) && pages > 0) {
            book.read = clamp((book.read || 0) + pages, 0, book.pages || 0);
        }

        book.updatedAt = nowISO();
        saveBooks();
        closeSessionModal();
        renderList();
        renderStats();
    }

    // =========================
    // Import / Export
    // =========================

    function exportLibrary() {
        const data = {
            version: 1,
            exportedAt: nowISO(),
            books: state.books
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reading-tracker-export-${formatDateYMD(new Date())}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    async function importLibrary(e) {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        try {
            const text = await file.text();
            const data = JSON.parse(text);
            if (!data || typeof data !== 'object') throw new Error('Invalid file format');
            const books = Array.isArray(data.books) ? data.books : (Array.isArray(data) ? data : []);
            if (!Array.isArray(books)) throw new Error('No books found in file');

            // Basic sanitize and normalize
            const cleaned = books.map(b => ({
                id: b.id || uid(),
                title: String(b.title || 'Untitled'),
                author: String(b.author || 'Unknown'),
                pages: Number.isFinite(b.pages) && b.pages > 0 ? Math.floor(b.pages) : 0,
                cover: typeof b.cover === 'string' ? b.cover : '',
                tags: Array.isArray(b.tags) ? b.tags.map(t => String(t)).filter(Boolean) : [],
                notes: typeof b.notes === 'string' ? b.notes : '',
                favorite: !!b.favorite,
                rating: Number.isFinite(b.rating) ? clamp(Math.floor(b.rating), 0, 5) : 0,
                read: Number.isFinite(b.read) ? clamp(Math.floor(b.read), 0, Number.isFinite(b.pages) ? b.pages : 0) : 0,
                sessions: Array.isArray(b.sessions) ? b.sessions.map(s => ({
                    date: s.date || formatDateYMD(new Date()),
                    minutes: Number.isFinite(s.minutes) && s.minutes > 0 ? Math.floor(s.minutes) : undefined,
                    pages: Number.isFinite(s.pages) && s.pages > 0 ? Math.floor(s.pages) : undefined
                })) : [],
                addedAt: b.addedAt || nowISO(),
                updatedAt: b.updatedAt || nowISO()
            }));

            // Merge strategy: append; if same id, replace
            const byId = new Map(state.books.map(b => [b.id, b]));
            cleaned.forEach(b => byId.set(b.id, b));
            state.books = Array.from(byId.values());

            saveBooks();
            renderTagChips();
            renderStats();
            renderList();
            updateEmptyState();

            // reset input so same file can be re-imported if desired
            e.target.value = '';
            alert('Import successful!');
        } catch (err) {
            console.error(err);
            alert('Failed to import: ' + err.message);
        }
    }
</script>
</body>
</html>
